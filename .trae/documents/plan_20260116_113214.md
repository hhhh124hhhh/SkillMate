# 公众号运营牛马 - 桌面通知功能实现计划

## 一、需求分析

### 1. 核心需求
- 当牛马完成工作时，向用户发送桌面通知
- 通知应该显示工作完成的信息
- 通知应该与应用的"牛马"定位相符
- 通知应该在不同操作系统上正常工作

### 2. 技术可行性
- ✅ Electron 支持桌面通知
- ✅ 项目已设置 App User Model ID (Windows 通知必要)
- ✅ AgentRuntime 有完整的工作完成回调机制
- ✅ 可以扩展现有代码架构

## 二、实现方案

### 1. 通知服务设计
- **创建通知服务**：在 `electron` 目录下创建 `NotificationService.ts`
- **通知类型**：
  - 工作完成通知
  - 错误通知
  - 提醒通知
- **通知配置**：支持启用/禁用通知

### 2. 通知触发机制
- **工作完成触发**：在 `AgentRuntime.ts` 的 `processUserMessage` 方法 finally 块中添加通知触发
- **错误触发**：在错误处理中添加错误通知
- **自定义触发**：添加 IPC 方法允许前端触发通知

### 3. 通知内容生成
- **工作类型识别**：根据处理的任务类型生成不同的通知内容
- **牛马风格**：使用符合"牛马"定位的语言风格
- **个性化**：添加工作完成的具体信息

### 4. 技术实现
- **主进程修改**：
  - 创建 `NotificationService.ts`
  - 在 `main.ts` 中集成通知服务
  - 添加通知相关的 IPC 处理

- **AgentRuntime 修改**：
  - 在工作完成时调用通知服务
  - 传递工作类型和结果信息

- **前端集成**：
  - 添加通知设置选项
  - 提供手动触发通知的能力

## 三、具体实现步骤

### 1. 创建通知服务
- **文件**：`electron/services/NotificationService.ts`
- **功能**：
  - 初始化通知服务
  - 发送不同类型的通知
  - 处理通知配置

### 2. 集成到主进程
- **修改**：`electron/main.ts`
- **功能**：
  - 初始化通知服务
  - 添加通知相关的 IPC 处理
  - 集成到系统托盘菜单

### 3. 修改 AgentRuntime
- **修改**：`electron/agent/AgentRuntime.ts`
- **功能**：
  - 在工作完成时触发通知
  - 在错误时触发错误通知
  - 传递工作信息给通知服务

### 4. 前端集成
- **修改**：`src/components/SettingsView.tsx`
- **功能**：
  - 添加通知设置选项
  - 允许用户配置通知偏好

### 5. 测试与优化
- **测试**：
  - 测试不同操作系统的通知
  - 测试不同工作类型的通知
  - 测试通知配置功能

- **优化**：
  - 优化通知内容和风格
  - 优化通知触发时机
  - 优化用户体验

## 四、预期效果

### 1. 工作完成通知
- **标题**：牛马工作完成
- **内容**：已完成 [工作类型] 任务，快来查看结果吧！
- **风格**：符合"牛马"定位的亲切语言

### 2. 错误通知
- **标题**：牛马遇到问题
- **内容**：[错误信息]，请检查配置或重试
- **风格**：友好的错误提示

### 3. 用户体验
- **及时反馈**：工作完成后立即通知
- **个性化**：根据工作类型显示不同内容
- **可配置**：用户可以控制通知偏好
- **跨平台**：在 Windows、macOS、Linux 上正常工作

## 五、技术要点

### 1. Electron 通知 API
- 使用 `new Notification()` 创建通知
- 处理不同操作系统的通知差异
- 确保通知权限正确设置

### 2. 架构设计
- 采用服务化设计，便于维护和扩展
- 集成到现有的 IPC 机制
- 遵循项目的代码风格和架构模式

### 3. 性能考虑
- 避免频繁发送通知
- 优化通知内容生成
- 确保通知不影响应用性能

通过实现这个通知功能，用户将能够及时了解牛马的工作状态，增强应用的用户体验，符合"牛马精神"的实用主义定位。