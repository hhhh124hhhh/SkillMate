---
name: test-driven-development
description: |
  测试驱动开发（TDD）- 在实施任何功能或修复错误之前使用，在编写实现代码之前必须使用。
  先写测试，看着它失败，编写最小代码通过。核心原则：如果你没看到测试失败，你就不知道它测试了什么。
---

# 测试驱动开发 (TDD)

## 概述

先写测试。看着它失败。编写最小代码通过。

**核心原则**：如果你没看到测试失败，你就不知道它测试了什么。

**违反规则的字面意思就是违反规则的精神。**

## 何时使用

**始终使用**：
- 新功能
- Bug 修复
- 重构
- 行为变更

**例外（需要人类伙伴许可）**：
- 一次性原型
- 生成的代码
- 配置文件

想"这次跳过 TDD"？停止。那是合理化。

## 铁律

```
没有失败的测试就没有生产代码
```

在测试之前写代码？删除它。重新开始。

**没有例外**：
- 不要将其保留为"参考"
- 不要在编写测试时"适应"它
- 不要看它
- 删除意味着删除

从头实施。仅此而已。

## Red-Green-Refactor

### RED - 编写失败测试

编写一个展示应该发生什么的最小测试。

**要求**：
- 一个行为
- 清晰的名称
- 真实代码（除非不可避免，否则不使用 mock）

### 验证 RED - 看着它失败

**强制。从不跳过。**

确认：
- 测试失败（不是错误）
- 失误消息符合预期
- 因为功能缺失而失败（不是拼写错误）

**测试通过？** 你正在测试现有行为。修复测试。

**测试错误？** 修复错误，重新运行直到正确失败。

### GREEN - 最小代码

编写最简单的代码来通过测试。

不要在测试之外添加功能、重构其他代码或"改进"。

### 验证 GREEN - 看着它通过

**强制。**

确认：
- 测试通过
- 其他测试仍然通过
- 输出干净（没有错误、警告）

**测试失败？** 修复代码，不是测试。

**其他测试失败？** 现在修复。

### REFACTOR - 清理

仅在绿色之后：
- 删除重复
- 改善名称
- 提取助手

保持测试绿色。不添加行为。

### 重复

下一个功能的下一个失败测试。

## 好测试

| 质量 | 好 | 坏 |
|------|-----|-----|
| **最小** | 一件事。名称中有"and"？拆分。 | `test('验证邮件和域名和空格')` |
| **清晰** | 名称描述行为 | `test('test1')` |
| **显示意图** | 演示所需的 API | 掩盖代码应该做什么 |

## 为什么顺序重要

**"我稍后会写测试来验证它有效"**

之后编写的测试立即通过。立即通过证明不了什么：
- 可能测试错误的东西
- 可能测试实现，不是行为
- 可能错过你忘记的边缘情况
- 你从未看到它捕获 bug

测试先行强迫你看到测试失败，证明它确实测试了某些东西。

## 验证清单

在将工作标记为完成之前：

- [ ] 每个新函数/方法都有测试
- [ ] 在实施之前看着每个测试失败
- [ ] 每个测试因预期原因而失败（功能缺失，不是拼写错误）
- [ ] 编写最小代码来通过每个测试
- [ ] 所有测试通过
- [ ] 输出干净（没有错误、警告）
- [ ] 测试使用真实代码（仅在不可避免时使用 mock）
- [ ] 覆盖边缘情况和错误

不能勾选所有框？你跳过了 TDD。重新开始。

## 常见合理化

| 借口 | 现实 |
|------|------|
| "太简单无法测试" | 简单代码会中断。测试需要 30 秒。 |
| "我稍后会测试" | 测试立即通过证明不了什么。 |
| "稍后测试达到相同目标" | 测试之后回答"这做什么？"测试之前回答"这应该做什么？" |
| "我已经手动测试了所有边缘情况" | 临时 ≠ 系统。没有记录，无法重新运行。 |
| "删除 X 小时的工作是浪费" | 沉没成本谬误。保留未经验证的代码是技术债务。 |
| "作为参考保留，先写测试" | 你会适应它。那是测试之后。删除意味着删除。 |
| "TDD 是教条的，务实意味着适应" | TDD 是务实的：在提交之前发现 bug（比之后调试更快）。 |
| "手动测试更快" | 手动不证明边缘情况。每次更改都要重新测试。 |

## 红旗 - 停止并重新开始

- 测试之前的代码
- 实施后的测试
- 测试立即通过
- 无法解释测试失败的原因
- 稍后添加测试
- 合理化"就这一次"
- "我已经手动测试了"
- "测试之后达到相同目的"
- "关于精神不是仪式"
- "作为参考保留"或"适应现有代码"
- "已经花了 X 小时，删除是浪费"
- "TDD 是教条的，我是务实的"
- "这不同因为..."

**所有这些意味着：删除代码。用 TDD 重新开始。**

## 示例：Bug 修复

**Bug**：接受空电子邮件

**RED**
```typescript
test('拒绝空电子邮件', async () => {
  const result = await submitForm({ email: '' });
  expect(result.error).toBe('需要电子邮件');
});
```

**验证 RED**
```bash
$ npm test
FAIL: expected '需要电子邮件', got undefined
```

**GREEN**
```typescript
function submitForm(data: FormData) {
  if (!data.email?.trim()) {
    return { error: '需要电子邮件' };
  }
  // ...
}
```

**验证 GREEN**
```bash
$ npm test
PASS
```

**REFACTOR**
如果需要，提取验证以处理多个字段。

## 最后规则

```
生产代码 → 测试存在且首先失败
否则 → 不是 TDD
```

未经人类伙伴许可，没有例外。
